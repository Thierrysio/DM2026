<?xml version="1.0" encoding="utf-8" ?>
<!-- 
CartPage.xaml
Cette page affiche le panier d'achat de l'utilisateur.
FonctionnalitÃ©s:
- Affichage de la liste des produits ajoutÃ©s au panier
- ContrÃ´le des quantitÃ©s pour chaque produit
- Calcul automatique du prix total
- PossibilitÃ© de supprimer des articles
- RÃ©servation d'un crÃ©neau horaire pour le retrait des produits
-->
<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             xmlns:converters="clr-namespace:DM2026.Converters"
             x:Class="DM2026.Views.CartPage"
             Title="Mon Panier"
             BackgroundColor="#FAF7F2">

    <ContentPage.Resources>
        <ResourceDictionary>
            <!-- Convertisseurs utilisÃ©s dans la page -->
            <converters:InvertBooleanConverter x:Key="InvertBooleanConverter" />
            <converters:StringNotEmptyConverter x:Key="StringNotEmptyConverter" />
            <!-- DÃ©finition de l'opacitÃ© rÃ©duite quand le dialogue est ouvert -->
            <OnPlatform x:TypeArguments="x:Double" x:Key="DialogOpenOpacity">
                <On Platform="Android,iOS,WinUI,MacCatalyst" Value="0.3" />
            </OnPlatform>
        </ResourceDictionary>
    </ContentPage.Resources>

    <Grid RowDefinitions="Auto,*,Auto" Padding="15">
        <!-- En-tÃªte du panier avec nombre d'articles -->
        <Frame Grid.Row="0" 
               BackgroundColor="White" 
               Padding="15" 
               CornerRadius="15" 
               HasShadow="True"
               Margin="0,0,0,15"
               Opacity="{Binding IsReservationDialogVisible, Converter={StaticResource InvertBooleanConverter}, ConverterParameter={StaticResource DialogOpenOpacity}, FallbackValue=1}">
            <Grid ColumnDefinitions="Auto,*">
                <Image Grid.Column="0" 
                       Source="dotnet_bot.png" 
                       HeightRequest="50" 
                       WidthRequest="50" 
                       Margin="0,0,15,0"/>

                <VerticalStackLayout Grid.Column="1">
                    <Label Text="Mon Panier d'Achats" 
                           FontSize="18" 
                           FontAttributes="Bold" 
                           TextColor="#1F1E1C"/>
                    <Label Text="{Binding CartItems.Count, StringFormat='{0} produits dans le panier'}" 
                           TextColor="#666666" 
                           FontSize="14"/>
                </VerticalStackLayout>
            </Grid>
        </Frame>

        <!-- Liste des produits dans le panier avec RefreshView pour actualisation -->
        <RefreshView Grid.Row="1" 
                 Command="{Binding RefreshCartCommand}" 
                 IsRefreshing="{Binding IsLoading}"
                 Opacity="{Binding IsReservationDialogVisible, Converter={StaticResource InvertBooleanConverter}, ConverterParameter={StaticResource DialogOpenOpacity}, FallbackValue=1}">
            <CollectionView ItemsSource="{Binding CartItems}">
                <CollectionView.ItemTemplate>
                    <DataTemplate>
                        <!-- Template pour chaque article du panier -->
                        <Frame Margin="0,0,0,10" 
                               Padding="15" 
                               CornerRadius="10" 
                               HasShadow="True" 
                               BackgroundColor="White">
                            <Grid ColumnDefinitions="Auto,*,Auto" RowDefinitions="Auto,Auto,Auto">
                                <!-- Image du produit -->
                                <Frame Grid.Column="0" 
                                       Grid.RowSpan="3"
                                       WidthRequest="80" 
                                       HeightRequest="80" 
                                       Padding="0" 
                                       CornerRadius="10" 
                                       IsClippedToBounds="True"
                                       Margin="0,0,15,0">
                                    <Image Source="{Binding Product.LesImages[0].Url, TargetNullValue='dotnet_bot.png'}" 
                                           Aspect="AspectFill"/>
                                </Frame>

                                <!-- Nom et prix unitaire du produit -->
                                <Label Grid.Column="1" 
                                       Grid.Row="0" 
                                       Text="{Binding Product.NomProduit}" 
                                       FontAttributes="Bold" 
                                       TextColor="#1F1E1C"
                                       MaxLines="2"
                                       LineBreakMode="TailTruncation"/>

                                <Label Grid.Column="1" 
                                       Grid.Row="1" 
                                       Text="{Binding Product.Prix, StringFormat='{0:F2} â‚¬ l unitÃ©'}" 
                                       TextColor="#666666" 
                                       FontSize="14"
                                       Margin="0,5,0,0"/>

                                <!-- ContrÃ´les pour ajuster la quantitÃ© (- et +) -->
                                <Grid Grid.Column="1" 
                                      Grid.Row="2" 
                                      ColumnDefinitions="Auto,Auto,Auto"
                                      VerticalOptions="End"
                                      Margin="0,10,0,0">
                                    <Button Grid.Column="0" 
                                            Text="-" 
                                            HeightRequest="35" 
                                            WidthRequest="35" 
                                            CornerRadius="17" 
                                            BackgroundColor="#F4B942" 
                                            TextColor="White"
                                            FontAttributes="Bold"
                                            Command="{Binding Source={RelativeSource AncestorType={x:Type ContentPage}}, Path=BindingContext.DecreaseQuantityCommand}"
                                            CommandParameter="{Binding}"/>

                                    <Label Grid.Column="1" 
                                           Text="{Binding Quantity}" 
                                           HorizontalOptions="Center" 
                                           VerticalOptions="Center" 
                                           FontSize="16" 
                                           TextColor="#1F1E1C"
                                           FontAttributes="Bold"
                                           Margin="15,0"/>

                                    <Button Grid.Column="2" 
                                            Text="+" 
                                            HeightRequest="35" 
                                            WidthRequest="35" 
                                            CornerRadius="17" 
                                            BackgroundColor="#F4B942" 
                                            TextColor="White"
                                            FontAttributes="Bold"
                                            Command="{Binding Source={RelativeSource AncestorType={x:Type ContentPage}}, Path=BindingContext.IncreaseQuantityCommand}"
                                            CommandParameter="{Binding}"/>
                                </Grid>

                                <!-- Prix total et bouton de suppression -->
                                <VerticalStackLayout Grid.Column="2" Grid.RowSpan="3" VerticalOptions="Center">
                                    <Label Text="{Binding TotalPrice, StringFormat='{0:F2} â‚¬'}" 
                                           TextColor="#F4B942" 
                                           FontAttributes="Bold" 
                                           HorizontalOptions="End"/>

                                    <Button Text="Supprimer" 
                                            BackgroundColor="Transparent" 
                                            TextColor="#FF5252" 
                                            FontSize="12"
                                            Margin="0,10,0,0"
                                            Command="{Binding Source={RelativeSource AncestorType={x:Type ContentPage}}, Path=BindingContext.RemoveItemCommand}"
                                            CommandParameter="{Binding}"/>
                                </VerticalStackLayout>
                            </Grid>
                        </Frame>
                    </DataTemplate>
                </CollectionView.ItemTemplate>
                <!-- Vue affichÃ©e lorsque le panier est vide -->
                <CollectionView.EmptyView>
                    <Grid RowDefinitions="*,Auto,Auto" VerticalOptions="Center" Padding="20">
                        <Image Grid.Row="0" 
                               Source="dotnet_bot.png" 
                               HeightRequest="120" 
                               Opacity="0.5" 
                               HorizontalOptions="Center"/>
                        <Label Grid.Row="1" 
                               Text="Votre panier est vide" 
                               FontSize="18" 
                               TextColor="#1F1E1C" 
                               HorizontalOptions="Center"
                               Margin="0,15,0,5"/>
                        <Label Grid.Row="2" 
                               Text="Ajoutez des produits pour commencer vos achats" 
                               TextColor="#666666" 
                               FontSize="14" 
                               HorizontalOptions="Center"/>
                    </Grid>
                </CollectionView.EmptyView>
            </CollectionView>
        </RefreshView>

        <!-- Pied de page avec total et bouton de rÃ©servation -->
        <Frame Grid.Row="2" 
               BackgroundColor="White" 
               Padding="15" 
               CornerRadius="15" 
               HasShadow="True"
               Margin="0,10,0,0"
               Opacity="{Binding IsReservationDialogVisible, Converter={StaticResource InvertBooleanConverter}, ConverterParameter={StaticResource DialogOpenOpacity}, FallbackValue=1}">
            <Grid RowDefinitions="Auto,Auto" ColumnDefinitions="*,Auto">
                <VerticalStackLayout Grid.Column="0" Grid.Row="0">
                    <Label Text="Total" 
                           FontSize="16" 
                           TextColor="#1F1E1C"/>
                    <Label Text="{Binding TotalAmount, StringFormat='{0:F2} â‚¬'}" 
                           FontSize="24" 
                           FontAttributes="Bold" 
                           TextColor="#F4B942"/>
                </VerticalStackLayout>

                <Button Grid.Column="1" 
                        Grid.Row="0" 
                        Text="RÃ©server" 
                        BackgroundColor="#F4B942" 
                        TextColor="White" 
                        CornerRadius="20"
                        HeightRequest="50"
                        WidthRequest="180"
                        FontAttributes="Bold"
                        Command="{Binding ShowReservationDialogCommand}"
                        IsEnabled="{Binding IsCartEmpty, Converter={StaticResource InvertBooleanConverter}}"/>

            </Grid>
        </Frame>

        <!-- Dialog modal pour choisir un crÃ©neau de rÃ©servation -->
        <Grid Grid.RowSpan="3" 
      BackgroundColor="#BF000000" 
      IsVisible="{Binding IsReservationDialogVisible}">
            <Frame BackgroundColor="White"
           CornerRadius="20"
           Margin="15"
           VerticalOptions="Center"
           HorizontalOptions="Fill"
           HasShadow="True">
                <StackLayout Spacing="10" Padding="5">
                    <!-- Titre avec icÃ´ne -->
                    <StackLayout Orientation="Horizontal" HorizontalOptions="Center" Margin="0,0,0,5">
                        <Image Source="dotnet_bot.png" HeightRequest="20" WidthRequest="20" />
                        <Label Text="Choisir un horaire"
                       FontSize="16"
                       FontAttributes="Bold"
                       VerticalOptions="Center"
                       Margin="5,0,0,0"/>
                    </StackLayout>

                    <!-- SÃ©parateur dÃ©coratif -->
                    <BoxView HeightRequest="1" BackgroundColor="#EEEEEE" />

                    <!-- Information sur le nombre de crÃ©neaux disponibles -->
                    <Frame BackgroundColor="#F5F5F5" CornerRadius="10" Padding="10" HasShadow="False">
                        <StackLayout Orientation="Horizontal">
                            <Label Text="ðŸ“…" FontSize="16" VerticalOptions="Center"/>
                            <Label Text="{Binding AvailableTimeSlots.Count, StringFormat='{0} crÃ©neaux disponibles'}"
                                   FontAttributes="Bold"
                                   TextColor="#1F1E1C"
                                   VerticalOptions="Center"
                                   Margin="10,0,0,0"/>
                        </StackLayout>
                    </Frame>

                    <!-- Instructions pour l'utilisateur -->
                    <Label Text="SÃ©lectionnez un crÃ©neau horaire pour votre retrait:"
                           TextColor="#555555"
                           FontSize="14"/>

                    <!-- SÃ©lecteur de crÃ©neau horaire -->
                    <Frame BorderColor="#DDDDDD" BackgroundColor="#FFFFFF" CornerRadius="10" Padding="5" HasShadow="False">
                        <Picker ItemsSource="{Binding AvailableTimeSlots}"
                                ItemDisplayBinding="{Binding DisplayText}"
                                SelectedItem="{Binding SelectedTimeSlot}"
                                Title="Appuyez pour choisir un horaire"
                                TextColor="#333333"
                                BackgroundColor="Transparent"
                                Margin="5,0"/>
                    </Frame>

                    <!-- Affichage du crÃ©neau sÃ©lectionnÃ© -->
                    <Frame IsVisible="{Binding SelectedTimeSlot, Converter={StaticResource StringNotEmptyConverter}}"
                           BackgroundColor="#F4F9FF" 
                           BorderColor="#D0E1F9" 
                           CornerRadius="10" 
                           Padding="10" 
                           HasShadow="False">
                        <StackLayout>
                            <Label Text="Horaire sÃ©lectionnÃ©:" 
                                   TextColor="#555555" 
                                   FontSize="14"/>
                            <Grid ColumnDefinitions="Auto,*" RowDefinitions="Auto,Auto" Margin="0,5,0,0">
                                <Label Grid.Row="0" Grid.Column="0" Text="ðŸ“†" FontSize="16"/>
                                <Label Grid.Row="0" Grid.Column="1" 
                                       Text="{Binding SelectedTimeSlot.FormattedDay}"
                                       TextColor="#1F1E1C"
                                       FontAttributes="Bold"/>

                                <Label Grid.Row="1" Grid.Column="0" Text="ðŸ•’" FontSize="16"/>
                                <Label Grid.Row="1" Grid.Column="1" 
                                       Text="{Binding SelectedTimeSlot.FormattedTimeRange}"
                                       TextColor="#1F1E1C"
                                       FontAttributes="Bold"/>
                            </Grid>
                        </StackLayout>
                    </Frame>

                    <!-- Boutons d'actions (Annuler/Confirmer) -->
                    <Grid ColumnDefinitions="*,*" ColumnSpacing="10" Margin="0,10,0,0">
                        <Button Grid.Column="0"
                                Text="Annuler"
                                BackgroundColor="#EEEEEE"
                                TextColor="#555555"
                                FontAttributes="Bold"
                                CornerRadius="10"
                                Command="{Binding CancelReservationCommand}"/>

                        <Button Grid.Column="1"
                                Text="Confirmer"
                                BackgroundColor="#F4B942"
                                TextColor="White"
                                FontAttributes="Bold"
                                CornerRadius="10"
                                Command="{Binding ReserveOrderCommand}"/>
                    </Grid>
                </StackLayout>
            </Frame>
        </Grid>

        <!-- Indicateur de chargement (spinner) -->
        <ActivityIndicator Grid.RowSpan="3" 
                          IsRunning="{Binding IsLoading}" 
                          IsVisible="{Binding IsLoading}"
                          VerticalOptions="Center" 
                          HorizontalOptions="Center"
                          Color="#F4B942"/>
    </Grid>
</ContentPage>